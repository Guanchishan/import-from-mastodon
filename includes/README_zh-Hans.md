## class-import-from-mastodon.php

这段代码定义了一个叫做 `Import_From_Mastodon` 的 PHP 类，这个类应该是 WordPress 插件的主要部分。它的主要功能包括定时从 Mastodon 网站获取更新（也称为 toots）并导入到你的 WordPress 站点。

以下是该类的主要组成部分：

1.  **单例模式**: `Import_From_Mastodon` 类使用了单例模式，这意味着该类的实例只能创建一次，这通过 `get_instance` 方法和私有的构造函数 `__construct` 实现。
    
2.  **实例变量**：`Import_From_Mastodon`类有两个私有实例变量 `$import_handler` 和 `$options_handler`，它们分别代表 Import 和 Options 的处理器实例。它们被赋值和初始化在 `register` 方法中。
    
3.  **register方法**: 该方法负责初始化类的主要组件，注册钩子回调函数以及计划定时任务。
    
4.  **定时任务**：方法 `add_cron_schedule` 添加了一个新的 WP Cron 间隔，每15分钟执行一次。在 `activate` 方法中，如果不存在一个预定的 'import\_from\_mastodon\_get\_statuses' 事件，就会使用这个间隔调度一个。`deactivate` 方法则用来清除这个计划任务。
    
5.  **激活和停用**：`activate` 和 `deactivate` 是插件生命周期的一部分，当插件被激活或停用时，它们会被调用。在这个例子中，它们被用于调度和清除定时任务。
    
6.  **本地化**：`load_textdomain` 方法是用来加载插件的本地化文件，这样插件就可以支持多种语言。
    

总的来说，这段代码创建了一个 WordPress 插件，该插件每 15 分钟从 Mastodon 网站导入更新（toots）。该插件使用了插件的生命周期（激活和停用），并且可以根据本地语言设置进行本地化。

## class-import-handler.php

### 功能

这个PHP脚本是一种在WordPress中从Mastodon导入帖子的工具。它主要的功能有：

1.  **内容清理和格式化**：通过wp\_kses函数清理和格式化内容，只保留链接（a标签），段落（p标签）和换行（br标签）。
    
2.  **内容重复检查和管理**：如果内容已经存在，将不会导入。这包括对Mastodon帖子的重新发布和回复。
    
3.  **内容为空的检查**：如果内容为空并且没有媒体附件，将跳过。
    
4.  **标题生成**：如果内容不为空，将从内容中生成标题。如果内容为空但媒体附件的描述不为空，将从媒体附件的描述生成标题。
    
5.  **内容和标题的过滤**：允许通过使用apply\_filters函数来重写自动生成的内容和标题。
    
6.  **帖子插入**：通过wp\_insert\_post函数插入帖子，并设置一些元数据，比如作者，分类，发布状态等。
    
7.  **媒体附件管理**：如果帖子包含媒体附件（目前只支持图像），则会下载并创建一个WordPress附件。第一个成功上传的附件将被设置为特色图像。
    
8.  **Mastodon账户管理**：该脚本还有一个获取已认证用户的Mastodon账户ID的函数。
    
9.  **错误日志**：有许多错误检查和日志记录步骤，以帮助识别和解决问题。

### 原理
    
这个脚本的工作原理是通过Mastodon API获取信息，然后根据得到的信息在WordPress中创建帖子。

首先，这段代码使用了`wp_kses`函数来清理并过滤从Mastodon返回的状态消息内容，然后存储到`$content`变量中。`wp_kses`函数的作用是确保输入的内容安全，防止潜在的XSS攻击。它的第一个参数是要清理的数据，第二个参数是一个允许的HTML元素和属性的列表。这里，允许的HTML元素包括`a`，`br`和`p`标签。

接着，这段代码检查Mastodon状态是否是一个转发的消息。如果是，那么将转发的消息内容也保存到`$content`变量中，并且将转发的消息包含在一个块引用（blockquote）中，为了给读者提供更多的上下文信息。

如果Mastodon状态是一个回复，则这段代码会尝试获取父级状态并将其内容添加到`$content`中，为回复提供上下文。

在处理完Mastodon状态的内容后，代码会生成一个文章的标题，方法是从内容中提取前10个词。如果内容为空，且有媒体附件存在，那么标题则从媒体附件的描述中生成。

接下来，这段代码定义了一个新文章的参数数组，然后使用`wp_insert_post`函数将这个新文章插入到WordPress数据库中。在插入新文章时，它还会检查是否有媒体附件，如果有，会将这些媒体附件也导入到WordPress。

此外，这段代码中还包含了一些错误处理和日志记录功能。例如，当从Mastodon API获取数据出现问题，或者插入新文章失败时，会有错误日志输出。

另外，该代码还包含一个名为`create_attachment`的函数，其作用是从Mastodon下载图像并将其导入到WordPress媒体库中。

最后，这段代码还包含两个辅助功能函数，一个是获取Mastodon账户的ID，另一个是检查是否已经存在相似的文章。

总的来说，这段代码是一个处理从Mastodon社交平台导入数据到WordPress的插件。它将Mastodon的状态消息转换为WordPress的文章，并处理媒体附件和其他相关信息，以在WordPress网站上正确显示。